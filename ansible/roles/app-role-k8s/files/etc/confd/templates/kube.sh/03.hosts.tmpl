hostsFile=/etc/hosts
sed "/^# >> QKE nodes./,/^# << QKE nodes./d" $hostsFile > $hostsFile.swap
firstMasterIp="$(echo "$allNodes" | grep ^stable/master/1/ | cut -d/ -f7)"
{{- with $lbIpFromV1 }}
lbIp={{ . }}
{{- else }}
lbIp="$(awk -F/ '{print $2}' $APISERVER_LB_FILE | grep . || echo -n)"
{{- end }}

{{- if $lbEipId }}
lbEip="$(awk -F/ '{print $3}' $APISERVER_LB_FILE | grep . || echo -n)"
{{- end }}

printHostEntry() {
  echo $1$'\t'$2
}

{{- $myZone := getv "/host/zone" }}
{{- $iaasApiServer := map "pek3" "10.140.24.6" "pek3a" "10.91.84.7" "pek3b" "10.140.24.6" "pek3c" "10.140.24.6" "pek3d" "10.140.24.6" "pekt3" "10.181.0.34" "pekt3d" "10.181.0.34" "sh1" "10.120.47.8" "sh1a" "10.120.47.8" "sh1b" "10.120.47.8" "gd2" "10.150.21.8" "gd2a" "10.150.21.8" "gd2b" "10.150.21.8" "ap2a" "10.160.3.4" "ap3a" "10.200.1.13"}}
staticApiIp={{ index $iaasApiServer $myZone }}
apiServer={{ getv "/cluster/api_server/host" "ks.api.qingcloud.com" }}
dynamicApiIp=$(dig +timeout=2 +short $apiServer | head -n 1)

flush >> $hostsFile.swap << HOSTS_FILE
# >> QKE nodes. WARNING: this is managed by script and please don't touch manually.
$(printHostEntry 127.0.1.1 $myNodeName)
$(printHostEntry 0.0.0.0 dl.k8s.io)
$(printHostEntry ${dynamicApiIp:-$staticApiIp} $apiServer)
$(printHostEntry ${lbIp:-$firstMasterIp} loadbalancer)
$(echo "$allNodes" | awk -F/ '{printf("%s\t%s %s%s\n", $7, $4, $5, $2~/^n/ ? " "$2$3 : "")}')

{{- with (getv "/env/host_aliases" "") }}
{{ replace . "," "\n" -1 }}
{{- end }}
# << QKE nodes. WARNING: this is managed by script and please don't touch manually.
HOSTS_FILE
mv $hostsFile.swap $hostsFile
